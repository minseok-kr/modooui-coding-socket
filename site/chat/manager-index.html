<html>

<head>
    <meta charset="utf-8" />
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/color/jquery.color-2.1.2.min.js" integrity="sha256-H28SdxWrZ387Ldn0qogCzFiUDDxfPiNIyJX7BECQkDE="
        crossorigin="anonymous"></script>
    <!--    <script src="./js/client.js"></script>-->
    <!--    <script src="./js/manager.js"></script>-->

    <script src="../asset/js/common.js"></script>

    <title>모두의 코딩</title>

    <!-- Code Mirror -->
    <link rel="stylesheet" href='/asset/css/code-mirror-style.css' />
    <link rel="stylesheet" href='/asset/css/common.css' />
    <link rel="stylesheet" href='/asset/css/manager-code.css' />
    <link rel="stylesheet" href='/asset/css/chips.css' />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.41.0/codemirror.min.js"></script>

    <!--        Highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.41.0/addon/runmode/colorize.js"></script>
    <!--        Javascript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.41.0/mode/javascript/javascript.min.js"></script>

    <!--        Python -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.41.0/mode/python/python.min.js"></script>


    <link rel="stylesheet" href="/asset/css/bootstrap-theme.min.css">

    <link href='https://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-kr.css' rel='stylesheet' type='text/css'>

    <link href="/asset/css/styles.css" rel="stylesheet" type='text/css' />
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="/">모두의 코딩</a>

            <div class="mr-auto"></div>
            <div id="nav-profile">

                <img id="client-image" class="rounded-circle" src="https://lh6.googleusercontent.com/-hezxJKyrbUs/AAAAAAAAAAI/AAAAAAAAADs/tJTe8OEjjBs/photo.jpg"
                    width="30" height="30" />
                <span id="nav-client-name">박민석</span>
            </div>
        </div>
    </nav>
    <div class="jumbotron"></div>
    <div class="container">
        <p id='send-state'></p>

        <h1>Partner</h1>
        <button id="btn_invite" class="btn btn-success">초대링크 생성</button>
        <div id="wrapper-code"></div>

        <div id="container-control" style="display: none;">
            <button id='btn_fail' class='btn btn-danger'>실패</button>
            <button id='btn_success' class='btn btn-success'>성공
            </button>
        </div>
    </div>

    <div id="blind"></div>
</body>

<script>

    let containerList = [];
    let nameLabel = ["박민석"]
    /* Socket.io 초기 설정 */
    $(function () {
        /**
       *   코드 에디터 초기화.
       */

        let getCodeEditor = function (i) {
            return `<div class="card client-view"><div class="card-body"><div class="client-code-view"><div id="txt-code-manager-` + String(i + 1) + `" class="inner-code-view code-small-view"></div></div></div></div>`
        }

        let getCodeLabel = function (i) {
            return `<div><div style="display:none" class='control-panel'><button id='btn_fail-1' class='btn btn-danger'>실패</button>
            <button id='btn_success-1' class='btn btn-success'>성공</button></div><div class="chip"><img class="chip-head" src='https://lh6.googleusercontent.com/-hezxJKyrbUs/AAAAAAAAAAI/AAAAAAAAADs/tJTe8OEjjBs/photo.jpg'/><div class="chip-content">` + nameLabel[0] + `</div></div></div>`
        }

        for (let i = 0; i < 4; i++) {
            $('#wrapper-code').append(getCodeEditor(i))

            let partnerCodeMirror = CodeMirror(document.getElementById("txt-code-manager-" + String(i + 1)), {
                lineNumbers: true,
                mode: "python",
                tabSize: 8,
                showCursorWhenSelecting: false
            });

            $(".card-body:has(#txt-code-manager-" + String(i + 1) + ")").append(getCodeLabel(i))

            let id = "aaa"
            if (i == 1) { id = "bbb" }
            if (i == 2) { id = "ccc" }

            codeView = {
                clientId: id,
                view: partnerCodeMirror
            }

            containerList.push(codeView);
        }
        $(".CodeMirror textarea").attr("readonly", true);

        var socket = io();
        var sendStatus = document.getElementById('send-state');

        socket.on('connection', function (data) {
            sendStatus.innerHTML = data;
        });

        socket.on('newMessage', (data) => {
            sendStatus.innerHTML = data;
        });

        socket.on('codeUpdate', (data) => {
            $codeEditor = $("#wrapper-code");
            // partnerCodeMirror.setValue(data);
            containerList.forEach(function (ele) {
                if (ele.clientId == "aaa") {
                    ele.view.setValue(data);
                }
            })

            $codeEditor.removeClass('helpped_client');
            $codeEditor.removeClass('submitted_client');

            $codeEditor.css({ backgroundColor: "#FFFF0050" });
            $codeEditor.stop().animate({ backgroundColor: "#FFFFFF" }, 500);

            // 업데이트시 제출 취소
            hideControlBox();
        });

        socket.on('somebodyHelp', (data) => {
            $("#wrapper-code").addClass('helpped_client');
            $codeEditor.css({ backgroundColor: "red" });
        });

        socket.on('somebodySubmit', (data) => {
            $("#wrapper-code").addClass('submitted_client');
            $codeEditor.css({ backgroundColor: "blue" });

            showControlBox();
        });

        /**
        *   Socket 관련 로직
        */
        function emitMessage(message) {
            socket.emit('message', message);
        }

        function emitCodeUpdate(code) {
            socket.emit('code', code);
        }

        function emitSubmitAnswer(answer) {
            socket.emit('submitAnswer', answer);
        }

        // $(".client-code-view textarea").attr("readonly", true);

        $(".card").click(function () {
            if (!$(this).hasClass('huge')) {
                $(this).css({
                    "position": "fixed",
                    // "width": window.innerWidth - 400,
                    "width": 1000,
                    // "height": window.innerHeight - 400,
                    "height": 600,
                    "left": 200,
                    "top": 200,
                    "z-index": 999
                })
                $(this).addClass('huge');
                $('#blind').stop()
                    .css({ "display": "block", "opacity": 0 })
                    .animate({ "opacity": 1 }, 500)

                $(".inner-code-view:nth-child(1)").removeClass('code-small-view')
                $(".inner-code-view:nth-child(1)").addClass('code-big-view');

                const refrsh = function () {
                    containerList[0].view.refresh()
                }
                setTimeout(refrsh, 50)
            }
        })

        $("#blind").click(function () {
            // $(".huge").trigger();

            let e = $(".huge")
            e.css({
                "position": "static",
                "width": 300,
                "height": 270,
                "left": 0,
                "top": 0,
                "z-index": 0
            })

            $('#blind').stop().animate({ "opacity": 0 }, 500, null, function () {
                $(this).css({ "display": "none" });
            })

            $(".inner-code-view:nth-child(1)").removeClass('code-big-view');
            $(".inner-code-view:nth-child(1)").addClass('code-small-view');

            e.removeClass('huge');
        })

        /**
        *   코드 에디터 동작
        */
        $("#txt-code-manager textarea").keyup(function () {
            /* Emit */
            //                emitCodeUpdate(myCodeMirror.getValue());
        })

        $("#btn_success").click(function () {
            emitSubmitAnswer("success");
            hideControlBox();
        })

        $("#btn_fail").click(function () {
            emitSubmitAnswer("fail");
            hideControlBox();
        })

        $("#btn_invite").click(function () {
            let paths = window.location.href.split('?')
            let room = paths[1];

            console.log(room);
            $.post('/api/invite/generate', { "room": room }, function (data) {
                let inviteCode = data.code

                $("#btn_invite").after("<h3><a href='/v/" + inviteCode + "'> " + "localhost:3000/v/" + inviteCode + "</h3>");
            });
        })

    })

</script>

</html>